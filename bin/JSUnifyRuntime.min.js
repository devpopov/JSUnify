(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q=[].slice,R={}.hasOwnProperty,U=function(e,t){function r(){this.constructor=e}for(var n in t)R.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};A=function(e){return console.log(e)},d=function(e){return console.dir(e)},L=function(e){return e.length},typeof exports=="undefined"&&(window.JSUnify={}),v=function(e,t){return typeof exports=="undefined"?window.JSUnify[e]=t:exports[e]=t},typeof exports=="undefined"?window.JSUnify.internal={}:exports.internal={},y=function(e,t){return typeof exports=="undefined"?window.JSUnify.internal[e]=t:exports.internal[e]=t},D=function(e){return typeof e=="undefined"?"undefined":e===null?"null":e.toString()},O=function(){var e,t,n,r,i,s;n={};for(i=0,s=arguments.length;i<s;i++){e=arguments[i];for(t in e)r=e[t],n[t]=r}return n},C=function(e){return typeof e=="undefined"},E=function(e){return typeof e=="boolean"},w=function(e){return e!=null&&Array.isArray(e)},N=function(e){return typeof e=="string"},x=function(e){return typeof e=="number"},T=function(e){return e!==null&&!w(e)&&typeof e=="object"},k=function(e){return E(e)||N(e)||x(e)},S=function(e){return!!(e&&e.constructor&&e.call&&e.apply)},P=function(t){var r;return w(t)?"["+function(){var e,n,i;i=[];for(e=0,n=t.length;e<n;e++)r=t[e],i.push(P(r));return i}().join(",")+"]":t instanceof e||t instanceof u||t instanceof f||t instanceof n?D(t):T(t)?"{"+function(){var e;e=[];for(r in t)e.push(r+":"+P(t[r]));return e}().join(",")+"}":N(t)?'"'+t+'"':D(t)},n=function(){function e(){}return e.prototype.toString=function(){return"new DictFlag()"},e}(),t=new n,e=function(){function e(e){if(!k(e)&&e!==null)throw"Can only box value types, not "+P(e);this.value=e}return e.prototype.toString=function(){return"new Box("+P(this.value)+")"},e}(),m=1,i="__B3qgfO__",b=function(e){return e.slice(0,i.length)===i},f=function(){function e(e){e==="_"?(this.name=i+m,m+=1):this.name=e}return e.prototype.isHiddenVar=function(){return b(this.name)},e.prototype.toString=function(){return"Var("+P(this.name)+")"},e}(),a=function(e){return new f(e)},u=function(){function t(e,t,n){this.node=t!=null?t:null,this.varlist=T(n)?n:null,this.chainlength=1,this.name=e}return t.prototype.end_of_chain=function(){var e;e=this;while(e.varlist instanceof t)e=e.varlist;return e},t.prototype.isfree=function(){var e;return e=this.end_of_chain(),e.node===null&&e.varlist===null},t.prototype.isHiddenVar=function(){return b(this.name)},t.prototype.toString=function(){return"new Tin("+P(this.name)+", "+P(this.node)+", "+P(this.varlist)+")"},t.prototype.get=function(t){var n,r;r=this.varlist[t],r!==null&&r!==void 0&&(r=r.end_of_chain());if(r==null)throw"Variable "+t+" not in this tin";if(r.node==null||r.node===null)return new a(r.name);if(r.node instanceof e)return j(r.node,r.varlist);if(r.node instanceof a)return j(r.node,r.varlist);if(w(r.node))return function(){var e,t,i,s;i=r.node,s=[];for(e=0,t=i.length;e<t;e++)n=i[e],s.push(j(n,r.varlist));return s}();throw"Unknown type in get"},t.prototype.get_all=function(){var e,t;e={};for(t in this.varlist)b(t)||(e[t]=this.get(t));return e},t.prototype.unparse=function(){return j(this.node)},t}(),p=function(n,r){var i,s,o;if(n instanceof f)return r!=null&&(r[n.name]=new u(n.name,null,null)),n;if(n instanceof e)return n;if(w(n))return function(){var e,t,i;i=[];for(e=0,t=n.length;e<t;e++)s=n[e],i.push(p(s,r));return i}();if(T(n)){i=[];for(o in n)i.push([p(o,r),p(n[o],r)]);return i.push(t),i.sort()}if(k(n||n===null))return new e(n);throw"Don't understand the type of elem"},j=function(n,r){var i,s,o,u,a,l,c;if(w(n)){if(n[n.length-1]===t){s=new Object,c=n.slice(0,n.length-1);for(a=0,l=c.length;a<l;a++)i=c[a],s[j(i[0])]=j(i[1]);return s}return function(){var e,t,r;r=[];for(e=0,t=n.length;e<t;e++)o=n[e],r.push(j(o));return r}()}if(n instanceof e)return n.value;if(n instanceof f){if(r!==void 0){try{u=g(r,n)}catch(h){return n}return j(u.node,u.varlist)}return n}throw"Unrecognized type '"+typeof n+"' in unboxit"},M=function(e){var t,n;return t={},n=p(e,t),new u(null,n,t)},g=function(e,t){if(!t instanceof f)throw"Node must be a Var to get_tin";if((e!=null?e[t.name]:void 0)!=null)return e[t.name];throw"Couldn't find node "+t.name+" in varlist "+e},c=function(e,t,n,r){return e=e.end_of_chain(),e.isfree()?(e.node=t,e.varlist=n,r.push(function(){return e.node=null,e.varlist=null,e.chainlength=1})):!1},h=function(e,t,n){return!e.isfree()&&!t.isfree()?!1:e.isfree()&&!t.isfree()?c(e,t.node,t.varlist,n):!e.isfree()&&t.isfree()?c(t,e.node,e.varlist,n):t.chainlength<e.chainlength?(t.chainlength+=1,c(t,null,e,n)):(e.chainlength+=1,c(e,null,t,n))},I=function(t,n,r,i,s){var o,u,a,l,p,d,v;s==null&&(s=[]);if(t===void 0&&r===void 0)return!0;if(t===null&&r===null)return!0;if(t===null||r===null)return!1;if(t instanceof f&&r instanceof f){a=g(n,t),l=g(i,r);if(!h(a,l,s)&&!I(a.node,a.varlist,l.node,l.varlist,s))return!1}else if(t instanceof f){a=g(n,t);if(!c(a,r,i,s)&&!I(a.node,a.varlist,r,i,s))return!1}else if(r instanceof f){l=g(i,r);if(!c(l,t,n,s)&&!I(l.node,l.varlist,t,n,s))return!1}else{if(t instanceof e&&r instanceof e&&k(t.value)&&k(r.value))return t.value===r.value;if(w(t)&&w(r)){if(t.length!==r.length)return!1;v=function(){var e,n,r;r=[];for(u=e=0,n=t.length;0<=n?e<=n:e>=n;u=0<=n?++e:--e)r.push(u);return r}();for(p=0,d=v.length;p<d;p++){o=v[p];if(!I(t[o],n,r[o],i,s))return!1}}}return!0},F=function(e,t,n){var r;return n==null&&(n=[]),r=!0,e=e instanceof u?e:M(e),t=t instanceof u?t:M(t),r=I(e.node,e.varlist,t.node,t.varlist,n),r===!1?null:[e,t]},_=function(e){var t,n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(t());return i},v("parse",M),v("unify",F),v("Var",a),y("Tin",u),y("Box",e),y("DictFlag",n),y("toJson",P),y("Variable",f),v("rollback",_),s=function(){function e(){this.rules=[],this.settings={}}return e.prototype.run=function(e){return e=new o(e),l(e,this.rules)},e.prototype.rule=function(){var e,t;return t=arguments[0],e=2<=arguments.length?q.call(arguments,1):[],this.rules.push(function(e,t,n){n.prototype=e.prototype;var r=new n,i=e.apply(r,t);return Object(i)===i?i:r}(o,[t].concat(q.call(e)),function(){})),this},e.prototype.iff=function(e){var t;if(this.rules.length===0)throw"iff is invalid in this context. A rule must be created first!";return t=this.rules[this.rules.length-1],t.iff(e),this},e.prototype.load=function(e){var t,n,r;for(n=0,r=e.length;n<r;n++)t=e[n],this.rules.push(t);return this},e}(),o=function(){function e(){var e,t,n,r,i;n=arguments[0],t=2<=arguments.length?q.call(arguments,1):[],this.fact=n,this.tin=M(n),this.conditions=[];for(r=0,i=t.length;r<i;r++)e=t[r],this.iff(e)}return e.prototype.iff=function(e){var t,n,i,s,o;S(e)?e=new r(e):e=M(e);if(this.conditions.length===0){t={},s=this.tin.varlist;for(n in s)i=s[n],t[n]=i}else t=this.conditions[0].varlist;o=e.varlist;for(n in o)i=o[n],t[n]===void 0&&(t[n]=i);return e.varlist=t,this.conditions.push(e),this},e}(),r=function(e){function t(e){this.func=e,t.__super__.constructor.call(this,null,null,{})}return U(t,e),t.prototype.bind=function(e,t){var n;return n=this.varlist[e].end_of_chain(),n.isfree()?(n.node=p(t,{}),!0):j(n.node)===t?!0:!1},t}(u),l=function(e,t){var n,i,s,u,a;e instanceof o&&(e=[e.tin]),n=e.pop();for(u=0,a=t.length;u<a;u++){s=t[u],n instanceof r?i=H(n,s,e,t):i=B(n,s,e,t);if(i!==null)return i}return e.push(n),null},B=function(e,t,n,r){var i,s,o,u,a;i=[];if(F(e,t.tin,i)){t.conditions.reverse(),a=t.conditions;for(o=0,u=a.length;o<u;o++)s=a[o],n.push(s);t.conditions.reverse();if(n.length===0)return e;if(l(n,r)!==null)return e}return _(i),null},H=function(e,t,n,r){return e.func(e)?e:null},v("Rule",o),v("Program",s)}).call(this)