(function(){var n,t,o,e,r,u,l,i,s,c=[].slice,f={}.hasOwnProperty,a=function(n,t){function o(){this.constructor=n}for(var e in t)f.call(t,e)&&(n[e]=t[e]);return o.prototype=t.prototype,n.prototype=new o,n.__super__=t.prototype,n};s="undefined"==typeof module?window.unify:require("unify"),"undefined"==typeof module&&(window.JSUnify={}),l=function(n,t){return"undefined"==typeof module?window.JSUnify[n]=t:module.exports[n]=t};for(i in s)l(i,s[i]);n=function(){function n(n){this.level=0,this.logger=n}return n.prototype.event=function(n,t){return("fail"===n||"exit"===n)&&this.level--,this.logger.log(""+this.level+" "+n+": "+t),"call"===n?this.level++:void 0},n}(),e=function(){function n(){this.rules=[],this.settings={debug:!1}}return n.prototype.run=function(n){var o;return n=s.box(n),o=function(t,o,e){return"try"===t&&console.log("try: "+s.toJson(o.goal.unbox())),"next"===t&&null!==o.rule?console.log("next: "+s.toJson(o.rule.tin.unbox())):"next"===t&&console.log("next:"),"fail"===t&&console.log("fail "+s.toJson(o.goal.unbox())),"success"===t&&(console.log(""),console.log(n.unbox()),console.log("")),null!==e?e():void 0},u(this.rules,[new t([n])],o)},n.prototype.rule=function(){var n,t;return t=arguments[0],n=arguments.length>=2?c.call(arguments,1):[],this.rules.push(function(n,t,o){o.prototype=n.prototype;var e=new o,r=n.apply(e,t);return Object(r)===r?r:e}(r,[t].concat(c.call(n)),function(){})),this},n.prototype.iff=function(n){var t;if(0===this.rules.length)throw"iff is invalid in this context. A rule must be created first!";return t=this.rules[this.rules.length-1],t.iff(n),this},n.prototype.load=function(n){var t,o,e;for(o=0,e=n.length;e>o;o++)t=n[o],this.rules.push(t);return this},n}(),r=function(){function n(){var n,t,o,e,r;for(o=arguments[0],t=arguments.length>=2?c.call(arguments,1):[],this.fact=o,this.tin=s.box(o),this.conditions=[],e=0,r=t.length;r>e;e++)n=t[e],this.iff(n)}return n.prototype.iff=function(n){var t,e,r,u,l;if(n=s.types.isFunc(n)?new o(n):s.box(n),0===this.conditions.length){t={},u=this.tin.varlist;for(e in u)r=u[e],t[e]=r}else t=this.conditions[0].varlist;l=n.varlist;for(e in l)r=l[e],void 0===t[e]&&(t[e]=r);return n.varlist=t,this.conditions.push(n),this},n}(),o=function(n){function t(n){this.func=n,t.__super__.constructor.call(this,null,null,{})}return a(t,n),t.prototype.toString=function(){return(""+this.func).replace(/(\r\n|\n|\r)/gm,"")},t.prototype.unbox=function(){return""+this},t}(s.TreeTin),t=function(){function n(n){this.subgoals=n,this.goal=this.subgoals.shift(),this.currentRule=0}return n}(),u=function(n,e,r){var l,i,s,c;if(l=e[e.length-1],i=l.goal,c=!1,s=null,0===l.currentRule?r("try",{goal:i},null):(r("retry",{goal:i},null),i.rollback()),i instanceof o)0===l.currentRule&&i.func(i)&&(c=!0,l.currentRule++);else for(;l.currentRule<n.length;){if(i.unify(n[l.currentRule].tin)){c=!0,s=n[l.currentRule],l.currentRule++;break}l.currentRule++}c?null!==s&&0!==s.conditions.length?(e.push(new t(s.conditions.concat(l.subgoals))),r("next",{goal:i,subgoals:l.subgoals,rule:s},function(){return u(n,e,r)})):0===l.subgoals.length?r("success",{goal:i},function(){return u(n,e,r)}):(e.push(new t(l.subgoals)),r("next",{goal:i,subgoals:null,rule:s},function(){return u(n,e,r)})):(e.pop(),0===e.length?(r("fail",{goal:i},null),r("done",{goal:i},null)):r("fail",{goal:i},function(){return u(n,e,r)}))},l("Rule",r),l("Program",e)}).call(this);