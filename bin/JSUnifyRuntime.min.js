(function(){var FunctionCondition,Program,Rule,backtrack,tryFunctionCondition,tryUnifyCondition,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Program=function(){function Program(){this.rules=[],this.settings={}}return Program.prototype.run=function(goal){return goal=new Rule(goal),backtrack(goal,this.rules)},Program.prototype.rule=function(){var conditions,fact;return fact=arguments[0],conditions=2<=arguments.length?__slice.call(arguments,1):[],this.rules.push(function(func,args,ctor){ctor.prototype=func.prototype;var child=new ctor,result=func.apply(child,args);return Object(result)===result?result:child}(Rule,[fact].concat(__slice.call(conditions)),function(){})),this},Program.prototype.iff=function(conditional){var rule;if(this.rules.length===0)throw"iff is invalid in this context. A rule must be created first!";return rule=this.rules[this.rules.length-1],rule.iff(conditional),this},Program.prototype.load=function(rules){var rule,_i,_len;for(_i=0,_len=rules.length;_i<_len;_i++)rule=rules[_i],this.rules.push(rule);return this},Program}(),Rule=function(){function Rule(){var c,conditions,fact,_i,_len;fact=arguments[0],conditions=2<=arguments.length?__slice.call(arguments,1):[],this.fact=fact,this.tin=parse(fact),this.conditions=[];for(_i=0,_len=conditions.length;_i<_len;_i++)c=conditions[_i],this.iff(c)}return Rule.prototype.iff=function(condition){var mergedVarlist,varKey,varValue,_ref,_ref1;isfunc(condition)?condition=new FunctionCondition(condition):condition=parse(condition);if(this.conditions.length===0){mergedVarlist={},_ref=this.tin.varlist;for(varKey in _ref)varValue=_ref[varKey],mergedVarlist[varKey]=varValue}else mergedVarlist=this.conditions[0].varlist;_ref1=condition.varlist;for(varKey in _ref1)varValue=_ref1[varKey],mergedVarlist[varKey]===void 0&&(mergedVarlist[varKey]=varValue);return condition.varlist=mergedVarlist,this.conditions.push(condition),this},Rule}(),FunctionCondition=function(_super){function FunctionCondition(func){this.func=func,FunctionCondition.__super__.constructor.call(this,null,null,{})}return __extends(FunctionCondition,_super),FunctionCondition.prototype.bind=function(var_name,value){var ver;return ver=this.varlist[var_name].end_of_chain(),ver.isfree()?(ver.node=boxit(value,{}),!0):unboxit(ver.node)===value?!0:!1},FunctionCondition}(Tin),backtrack=function(goals,rules){var goal,ret,rule,_i,_len;goals instanceof Rule&&(goals=[goals.tin]),goal=goals.pop();for(_i=0,_len=rules.length;_i<_len;_i++){rule=rules[_i],goal instanceof FunctionCondition?ret=tryFunctionCondition(goal,rule,goals,rules):ret=tryUnifyCondition(goal,rule,goals,rules);if(ret!==null)return ret}return goals.push(goal),null},tryUnifyCondition=function(goal,rule,goals,rules){var changes,cond,_i,_len,_ref;changes=[];if(unify(goal,rule.tin,changes)){rule.conditions.reverse(),_ref=rule.conditions;for(_i=0,_len=_ref.length;_i<_len;_i++)cond=_ref[_i],goals.push(cond);rule.conditions.reverse();if(goals.length===0)return goal;if(backtrack(goals,rules)!==null)return goal}return rollback(changes),null},tryFunctionCondition=function(goal,rule,goals,rules){return goal.func(goal)?goal:null},extern("Rule",Rule),extern("Program",Program)}).call(this)