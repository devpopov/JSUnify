(function(){var t,n,e,i,r,o,u,s,l,f,c=[].slice,h={}.hasOwnProperty,a=function(t,n){function e(){this.constructor=t}for(var i in n)h.call(n,i)&&(t[i]=n[i]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t};f="undefined"==typeof module?window.unify:require("unify"),"undefined"==typeof module&&(window.JSUnify={}),o=function(t,n){return"undefined"==typeof module?window.JSUnify[t]=n:module.exports[t]=n};for(u in f)o(u,f[u]);t=function(){function t(t){this.level=0,this.logger=t}return t.prototype.event=function(t,n){return("fail"===t||"exit"===t)&&this.level--,this.logger.log(""+this.level+" "+t+": "+n),"call"===t?this.level++:void 0},t}(),e=function(){function n(){this.rules=[],this.settings={debug:!1}}return n.prototype.run=function(n){return n=new i(n),r(n,this.rules,this.settings.debug?new t(console):{event:function(){}})},n.prototype.rule=function(){var t,n;return n=arguments[0],t=arguments.length>=2?c.call(arguments,1):[],this.rules.push(function(t,n,e){e.prototype=t.prototype;var i=new e,r=t.apply(i,n);return Object(r)===r?r:i}(i,[n].concat(c.call(t)),function(){})),this},n.prototype.iff=function(t){var n;if(0===this.rules.length)throw"iff is invalid in this context. A rule must be created first!";return n=this.rules[this.rules.length-1],n.iff(t),this},n.prototype.load=function(t){var n,e,i;for(e=0,i=t.length;i>e;e++)n=t[e],this.rules.push(n);return this},n}(),i=function(){function t(){var t,n,e,i,r;for(e=arguments[0],n=arguments.length>=2?c.call(arguments,1):[],this.fact=e,this.tin=f.box(e),this.conditions=[],i=0,r=n.length;r>i;i++)t=n[i],this.iff(t)}return t.prototype.iff=function(t){var e,i,r,o,u;if(t=f.types.isFunc(t)?new n(t):f.box(t),0===this.conditions.length){e={},o=this.tin.varlist;for(i in o)r=o[i],e[i]=r}else e=this.conditions[0].varlist;u=t.varlist;for(i in u)r=u[i],void 0===e[i]&&(e[i]=r);return t.varlist=e,this.conditions.push(t),this},t}(),n=function(t){function n(t){this.func=t,n.__super__.constructor.call(this,null,null,{})}return a(n,t),n.prototype.toString=function(){return(""+this.func).replace(/(\r\n|\n|\r)/gm,"")},n}(f.TreeTin),r=function(t,e,r){var o,u,f,c,h;for(t instanceof i&&(t=[t.tin]),o=t.pop(),r.event("call",o),c=0,h=e.length;h>c;c++)if(f=e[c],u=o instanceof n?s(o,f,t,e,r):l(o,f,t,e,r),null!==u)return r.event("exit",o),u;return r.event("fail",o),t.push(o),null},l=function(t,n,e,i,o){var u,s,l,f,c;if(u=[],t.unify(n.tin)){for(o.event("call",n.tin),n.conditions.reverse(),c=n.conditions,l=0,f=c.length;f>l;l++)s=c[l],e.push(s);if(n.conditions.reverse(),0===e.length)return t;if(null!==r(e,i,o))return t}return o.event("fail",n.tin),t.rollback(),null},s=function(t){return t.func(t)?t:null},o("Rule",i),o("Program",e)}).call(this);