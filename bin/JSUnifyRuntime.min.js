(function(){var n,t,e,i,u,r,o,l,s,a=[].slice,f={}.hasOwnProperty,c=function(n,t){function e(){this.constructor=n}for(var i in t)f.call(t,i)&&(n[i]=t[i]);return e.prototype=t.prototype,n.prototype=new e,n.__super__=t.prototype,n};s="undefined"==typeof module?window.unify:require("unify"),"undefined"==typeof module&&(window.JSUnify={}),o=function(n,t){return"undefined"==typeof module?window.JSUnify[n]=t:module.exports[n]=t};for(l in s)o(l,s[l]);n=function(){function n(n){this.level=0,this.logger=n}return n.prototype.event=function(n,t){return("fail"===n||"exit"===n)&&this.level--,this.logger.log(""+this.level+" "+n+": "+t),"call"===n?this.level++:void 0},n}(),i=function(){function n(){this.rules=[],this.settings={debug:!1}}return n.prototype.query=function(){var n,e,i;return e=arguments.length>=1?a.call(arguments,0):[],e=function(){var t,i,u;for(u=[],t=0,i=e.length;i>t;t++)n=e[t],u.push(s.box(n));return u}(),i=!1,r(this.rules,[new t(e.slice(0))],function(n,t){return"success"===n.name?i=!0:null!==t?t():void 0}),i?1===e.length?e[0]:e:null},n.prototype.queryAsync=function(n,e){var i,u;return u=e,null===e?u=function(n,t){return null!==t&&"success"!==n.name?t():void 0}:this.settings.debug||(u=function(n,t){return"done"===n.name?e(n,t):null!==t?t():void 0}),n=function(){var t,e,u;for(u=[],t=0,e=n.length;e>t;t++)i=n[t],u.push(s.box(i));return u}(),r(this.rules,[new t(n.slice(0))],u),n},n.prototype.rule=function(){var n,t;return t=arguments[0],n=arguments.length>=2?a.call(arguments,1):[],this.rules.push(function(n,t,e){e.prototype=n.prototype;var i=new e,u=n.apply(i,t);return Object(u)===u?u:i}(u,[t].concat(a.call(n)),function(){})),this},n.prototype.iff=function(n){var t;if(0===this.rules.length)throw"iff is invalid in this context. A rule must be created first!";return t=this.rules[this.rules.length-1],t.iff(n),this},n.prototype.load=function(n){var t,e,i;for(e=0,i=n.length;i>e;e++)t=n[e],this.rules.push(t);return this},n}(),u=function(){function n(){var t,e,i,u,r;for(i=arguments[0],e=arguments.length>=2?a.call(arguments,1):[],this.clone=function(){return function(n,t,e){e.prototype=n.prototype;var i=new e,u=n.apply(i,t);return Object(u)===u?u:i}(n,[i].concat(a.call(e)),function(){})},this.fact=i,this.tin=s.box(i),this.conditions=[],u=0,r=e.length;r>u;u++)t=e[u],this.iff(t)}return n.prototype.iff=function(n){var t,i,u,r,o;if(n=s.types.isFunc(n)?new e(n):s.box(n),0===this.conditions.length){t={},r=this.tin.varlist;for(i in r)u=r[i],t[i]=u}else t=this.conditions[0].varlist;o=n.varlist;for(i in o)u=o[i],void 0===t[i]&&(t[i]=u);return n.varlist=t,this.conditions.push(n),this},n}(),e=function(n){function t(n){this.func=n,t.__super__.constructor.call(this,null,null,{})}return c(t,n),t.prototype.toString=function(){return(""+this.func).replace(/(\r\n|\n|\r)/gm,"")},t.prototype.unbox=function(){return""+this},t}(s.TreeTin),t=function(){function n(n){this.subgoals=n,this.goal=this.subgoals.shift(),this.ruleIndex=0,this.satisfyingRule=null}return n}(),r=function(n,i,u){var o,l,s;if(o=i[i.length-1],l=o.goal,s=!1,o.satisfyingRule=null,0===o.ruleIndex?u({name:"try",goal:l},null):(u({name:"retry",goal:l},null),l.rollback()),l instanceof e)0===o.ruleIndex&&l.func(l)&&(s=!0,o.ruleIndex++);else for(;o.ruleIndex<n.length;){if(l.unify(n[o.ruleIndex].tin)){s=!0,o.satisfyingRule=n[o.ruleIndex],n[o.ruleIndex]=o.satisfyingRule.clone(),o.ruleIndex++;break}o.ruleIndex++}s?null!==o.satisfyingRule&&0!==o.satisfyingRule.conditions.length?(i.push(new t(o.satisfyingRule.conditions.concat(o.subgoals))),u({name:"next",goal:l,subgoals:o.subgoals,rule:o.satisfyingRule},function(){return r(n,i,u)})):0===o.subgoals.length?u({name:"success",goal:l},function(){return r(n,i,u)}):(i.push(new t(o.subgoals)),u({name:"next",goal:l,subgoals:null,rule:o.satisfyingRule},function(){return r(n,i,u)})):(i.pop(),0===i.length?(u({name:"fail",goal:l},null),u({name:"done",goal:l},null)):u({name:"fail",goal:l},function(){return r(n,i,u)}))},o("Rule",u),o("Program",i)}).call(this);