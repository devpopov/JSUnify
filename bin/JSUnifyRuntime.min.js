(function(){var n,t,e,u,i,r,o,s,l=[].slice,a={}.hasOwnProperty,c=function(n,t){function e(){this.constructor=n}for(var u in t)a.call(t,u)&&(n[u]=t[u]);return e.prototype=t.prototype,n.prototype=new e,n.__super__=t.prototype,n};s="undefined"==typeof module?window.unify:require("unify"),"undefined"==typeof module&&(window.JSUnify={}),r=function(n,t){return"undefined"==typeof module?window.JSUnify[n]=t:module.exports[n]=t};for(o in s)r(o,s[o]);e=function(){function t(){this.rules=[],this.settings={debug:!1}}return t.prototype.query=function(){var t,e,u;return e=arguments.length>=1?l.call(arguments,0):[],e=function(){var n,u,i;for(i=[],n=0,u=e.length;u>n;n++)t=e[n],i.push(s.box(t));return i}(),u=!1,i(this.rules,[new n(e.slice(0))],this.settings.debug?function(n,t){var e,i;return"function"==typeof(e={"try":function(n){return this.fail(n)},retry:function(n){return this.fail(n)},match:function(t){return console.log(""+t+": "+(null!==n.rule?s.toJson(n.rule.tin.unbox()):void 0))},fail:function(t){return console.log(""+t+": "+s.toJson(n.goal.unbox()))},done:function(n){return this.fail(n)},success:function(n){return this.match(n)}})[i=n.name]&&e[i](n.name),"success"===n.name?u=!0:null!==t?t():void 0}:function(n,t){return"success"===n.name?u=!0:null!==t?t():void 0}),u?1===e.length?e[0]:e:null},t.prototype.queryAsync=function(t,e){var u,r;return r=e,null===e?r=function(n,t){return null!==t&&"success"!==n.name?t():void 0}:this.settings.debug||(r=function(n,t){return"done"===n.name?e(n,t):null!==t?t():void 0}),t=function(){var n,e,i;for(i=[],n=0,e=t.length;e>n;n++)u=t[n],i.push(s.box(u));return i}(),i(this.rules,[new n(t.slice(0))],r),t},t.prototype.rule=function(){var n,t;return t=arguments[0],n=arguments.length>=2?l.call(arguments,1):[],this.rules.push(function(n,t,e){e.prototype=n.prototype;var u=new e,i=n.apply(u,t);return Object(i)===i?i:u}(u,[t].concat(l.call(n)),function(){})),this},t.prototype.iff=function(n){var t;if(0===this.rules.length)throw"iff is invalid in this context. A rule must be created first!";return t=this.rules[this.rules.length-1],t.iff(n),this},t.prototype.load=function(n){var t,e,u;for(e=0,u=n.length;u>e;e++)t=n[e],this.rules.push(t);return this},t}(),u=function(){function n(){var t,e,u,i,r;for(u=arguments[0],e=arguments.length>=2?l.call(arguments,1):[],this.clone=function(){return function(n,t,e){e.prototype=n.prototype;var u=new e,i=n.apply(u,t);return Object(i)===i?i:u}(n,[u].concat(l.call(e)),function(){})},this.fact=u,this.tin=s.box(u),this.conditions=[],i=0,r=e.length;r>i;i++)t=e[i],this.iff(t)}return n.prototype.iff=function(n){var e,u,i,r,o;if(n=s.types.isFunc(n)?new t(n):s.box(n),0===this.conditions.length){e={},r=this.tin.varlist;for(u in r)i=r[u],e[u]=i}else e=this.conditions[0].varlist;o=n.varlist;for(u in o)i=o[u],void 0===e[u]&&(e[u]=i);return n.varlist=e,this.conditions.push(n),this},n}(),t=function(n){function t(n){this.func=n,t.__super__.constructor.call(this,null,null,{})}return c(t,n),t.prototype.toString=function(){return(""+this.func).replace(/(\r\n|\n|\r)/gm,"")},t.prototype.unbox=function(){return""+this},t}(s.TreeTin),n=function(){function n(n){this.subgoals=n,this.subgoals=this.subgoals.slice(0),this.goal=this.subgoals.shift(),this.ruleIndex=0,this.satisfyingRule=null}return n}(),i=function(e,u,r){var o,s,l;if(o=u[u.length-1],s=o.goal,l=!1,o.satisfyingRule=null,0===o.ruleIndex?r({name:"try",goal:s},null):(s.rollback(),r({name:"retry",goal:s},null)),s instanceof t)0===o.ruleIndex&&s.func(s)&&(l=!0,o.ruleIndex++);else for(;o.ruleIndex<e.length;){if(s.unify(e[o.ruleIndex].tin)){l=!0,o.satisfyingRule=e[o.ruleIndex],e[o.ruleIndex]=o.satisfyingRule.clone(),o.ruleIndex++;break}o.ruleIndex++}l?null!==o.satisfyingRule&&0!==o.satisfyingRule.conditions.length?(u.push(new n(o.satisfyingRule.conditions.concat(o.subgoals))),r({name:"match",goal:s,subgoals:o.subgoals,rule:o.satisfyingRule},function(){return i(e,u,r)})):0===o.subgoals.length?r({name:"success",goal:s,rule:o.satisfyingRule},function(){return i(e,u,r)}):(u.push(new n(o.subgoals)),r({name:"match",goal:s,subgoals:null,rule:o.satisfyingRule},function(){return i(e,u,r)})):(u.pop(),0===u.length?r({name:"done",goal:s},null):r({name:"fail",goal:s},function(){return i(e,u,r)}))},r("Rule",u),r("Program",e)}).call(this);