(function(){var n,t,e,o,i,l,u,r,s,a=[].slice,f={}.hasOwnProperty,c=function(n,t){function e(){this.constructor=n}for(var o in t)f.call(t,o)&&(n[o]=t[o]);return e.prototype=t.prototype,n.prototype=new e,n.__super__=t.prototype,n};s="undefined"==typeof module?window.unify:require("unify"),"undefined"==typeof module&&(window.JSUnify={}),u=function(n,t){return"undefined"==typeof module?window.JSUnify[n]=t:module.exports[n]=t};for(r in s)u(r,s[r]);n=function(){function n(n){this.level=0,this.logger=n}return n.prototype.event=function(n,t){return("fail"===n||"exit"===n)&&this.level--,this.logger.log(""+this.level+" "+n+": "+t),"call"===n?this.level++:void 0},n}(),o=function(){function n(){this.rules=[],this.settings={debug:!1}}return n.prototype.run=function(n){var e;return n=s.box(n),e=function(t,e){return"try"===t.name&&console.log("try: "+s.toJson(t.goal.unbox())),"next"===t.name&&null!==t.rule?console.log("next: "+s.toJson(t.rule.tin.unbox())):"next"===t.name&&console.log("next:"),"fail"===t.name&&console.log("fail "+s.toJson(t.goal.unbox())),"success"===t.name&&(console.log(""),console.log(s.toJson(n.unbox())),console.log("")),null!==e?e():void 0},l(this.rules,[new t([n])],e)},n.prototype.rule=function(){var n,t;return t=arguments[0],n=arguments.length>=2?a.call(arguments,1):[],this.rules.push(function(n,t,e){e.prototype=n.prototype;var o=new e,i=n.apply(o,t);return Object(i)===i?i:o}(i,[t].concat(a.call(n)),function(){})),this},n.prototype.iff=function(n){var t;if(0===this.rules.length)throw"iff is invalid in this context. A rule must be created first!";return t=this.rules[this.rules.length-1],t.iff(n),this},n.prototype.load=function(n){var t,e,o;for(e=0,o=n.length;o>e;e++)t=n[e],this.rules.push(t);return this},n}(),i=function(){function n(){var t,e,o,i,l;for(o=arguments[0],e=arguments.length>=2?a.call(arguments,1):[],this.clone=function(){return function(n,t,e){e.prototype=n.prototype;var o=new e,i=n.apply(o,t);return Object(i)===i?i:o}(n,[o].concat(a.call(e)),function(){})},this.fact=o,this.tin=s.box(o),this.conditions=[],i=0,l=e.length;l>i;i++)t=e[i],this.iff(t)}return n.prototype.iff=function(n){var t,o,i,l,u;if(n=s.types.isFunc(n)?new e(n):s.box(n),0===this.conditions.length){t={},l=this.tin.varlist;for(o in l)i=l[o],t[o]=i}else t=this.conditions[0].varlist;u=n.varlist;for(o in u)i=u[o],void 0===t[o]&&(t[o]=i);return n.varlist=t,this.conditions.push(n),this},n}(),e=function(n){function t(n){this.func=n,t.__super__.constructor.call(this,null,null,{})}return c(t,n),t.prototype.toString=function(){return(""+this.func).replace(/(\r\n|\n|\r)/gm,"")},t.prototype.unbox=function(){return""+this},t}(s.TreeTin),t=function(){function n(n){this.subgoals=n,this.goal=this.subgoals.shift(),this.ruleIndex=0,this.satisfyingRule=null}return n}(),l=function(n,o,i){var u,r,s;if(u=o[o.length-1],r=u.goal,s=!1,u.satisfyingRule=null,0===u.ruleIndex?i({name:"try",goal:r},null):(i({name:"retry",goal:r},null),r.rollback()),r instanceof e)0===u.ruleIndex&&r.func(r)&&(s=!0,u.ruleIndex++);else for(;u.ruleIndex<n.length;){if(r.unify(n[u.ruleIndex].tin)){s=!0,u.satisfyingRule=n[u.ruleIndex],n[u.ruleIndex]=u.satisfyingRule.clone(),u.ruleIndex++;break}u.ruleIndex++}s?null!==u.satisfyingRule&&0!==u.satisfyingRule.conditions.length?(o.push(new t(u.satisfyingRule.conditions.concat(u.subgoals))),i({name:"next",goal:r,subgoals:u.subgoals,rule:u.satisfyingRule},function(){return l(n,o,i)})):0===u.subgoals.length?i({name:"success",goal:r},function(){return l(n,o,i)}):(o.push(new t(u.subgoals)),i({name:"next",goal:r,subgoals:null,rule:u.satisfyingRule},function(){return l(n,o,i)})):(o.pop(),0===o.length?(i({name:"fail",goal:r},null),i({name:"done",goal:r},null)):i({name:"fail",goal:r},function(){return l(n,o,i)}))},u("Rule",i),u("Program",o)}).call(this);