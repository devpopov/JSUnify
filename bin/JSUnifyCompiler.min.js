(function(){var n,t,e,u,r,i,o,l,s,a,f=[].slice,c={}.hasOwnProperty,p=function(n,t){function e(){this.constructor=n}for(var u in t)c.call(t,u)&&(n[u]=t[u]);return e.prototype=t.prototype,n.prototype=new e,n.__super__=t.prototype,n};a="undefined"==typeof module?window.unify:require("unify"),"undefined"==typeof module&&(window.JSUnify={}),o=function(n,t){return"undefined"==typeof module?window.JSUnify[n]=t:module.exports[n]=t};for(s in a)o(s,a[s]);e=function(){function t(){this.rules=[],this.settings={debug:!1}}return t.prototype.query=function(){var t,e,u;return e=arguments.length>=1?f.call(arguments,0):[],e=function(){var n,u,r;for(r=[],n=0,u=e.length;u>n;n++)t=e[n],r.push(a.box(t));return r}(),u=!1,r(this.rules,[new n(e.slice(0))],this.settings.debug?function(n,t){switch(n.name){case"match":case"success":console.log(""+n.depth+" "+n.name+": "+(null!==n.rule?a.toJson(n.rule.tin.unbox()):void 0));break;default:console.log(""+n.depth+" "+n.name+": "+a.toJson(n.goal.unbox()))}return"success"===n.name?u=!0:null!==t?t():void 0}:function(n,t){return"success"===n.name?u=!0:null!==t?t():void 0}),u?1===e.length?e[0]:e:null},t.prototype.queryAsync=function(t,e){var u,i;return i=e,null===e?i=function(n,t){return null!==t&&"success"!==n.name?t():void 0}:this.settings.debug||(i=function(n,t){return"done"===n.name?e(n,t):null!==t?t():void 0}),t=function(){var n,e,r;for(r=[],n=0,e=t.length;e>n;n++)u=t[n],r.push(a.box(u));return r}(),r(this.rules,[new n(t.slice(0))],i),t},t.prototype.rule=function(){var n,t;return t=arguments[0],n=arguments.length>=2?f.call(arguments,1):[],this.rules.push(function(n,t,e){e.prototype=n.prototype;var u=new e,r=n.apply(u,t);return Object(r)===r?r:u}(u,[t].concat(f.call(n)),function(){})),this},t.prototype.iff=function(n){var t;if(0===this.rules.length)throw"iff is invalid in this context. A rule must be created first!";return t=this.rules[this.rules.length-1],t.iff(n),this},t.prototype.load=function(n){var t,e,u;for(e=0,u=n.length;u>e;e++)t=n[e],this.rules.push(t);return this},t}(),u=function(){function n(){var t,e,u,r,i;for(u=arguments[0],e=arguments.length>=2?f.call(arguments,1):[],this.clone=function(){return function(n,t,e){e.prototype=n.prototype;var u=new e,r=n.apply(u,t);return Object(r)===r?r:u}(n,[u].concat(f.call(e)),function(){})},this.fact=u,this.tin=a.box(u),this.conditions=[],r=0,i=e.length;i>r;r++)t=e[r],this.iff(t)}return n.prototype.iff=function(n){var e,u,r,i,o;if(n=a.types.isFunc(n)?new t(n):a.box(n),0===this.conditions.length){e={},i=this.tin.varlist;for(u in i)r=i[u],e[u]=r}else e=this.conditions[0].varlist;o=n.varlist;for(u in o)r=o[u],void 0===e[u]&&(e[u]=r);return n.varlist=e,this.conditions.push(n),this},n}(),t=function(n){function t(n){this.func=n,t.__super__.constructor.call(this,null,null,{})}return p(t,n),t.prototype.toString=function(){return(""+this.func).replace(/(\r\n|\n|\r)/gm,"")},t.prototype.unbox=function(){return""+this},t}(a.TreeTin),n=function(){function n(n){this.subgoals=n,this.subgoals=this.subgoals.slice(0),this.goal=this.subgoals.shift(),this.ruleIndex=0,this.satisfyingRule=null}return n}(),r=function(e,u,i){var o,l,s;if(o=u[u.length-1],l=o.goal,s=!1,o.satisfyingRule=null,0===o.ruleIndex?i({name:"try",goal:l,depth:u.length},null):(l.rollback(),i({name:"retry",goal:l,depth:u.length},null)),l instanceof t)0===o.ruleIndex&&l.func(l)&&(s=!0,o.ruleIndex++);else for(;o.ruleIndex<e.length;){if(l.unify(e[o.ruleIndex].tin)){s=!0,o.satisfyingRule=e[o.ruleIndex],e[o.ruleIndex]=o.satisfyingRule.clone(),o.ruleIndex++;break}o.ruleIndex++}s?null!==o.satisfyingRule&&0!==o.satisfyingRule.conditions.length?(u.push(new n(o.satisfyingRule.conditions.concat(o.subgoals))),i({name:"match",goal:l,subgoals:o.subgoals,rule:o.satisfyingRule,depth:u.length},function(){return r(e,u,i)})):0===o.subgoals.length?i({name:"success",goal:l,rule:o.satisfyingRule,depth:u.length},function(){return r(e,u,i)}):(u.push(new n(o.subgoals)),i({name:"match",goal:l,subgoals:null,rule:o.satisfyingRule,depth:u.length},function(){return r(e,u,i)})):(u.pop(),0===u.length?i({name:"done",goal:l,depth:u.length},null):i({name:"fail",goal:l,depth:u.length},function(){return r(e,u,i)}))},o("Rule",u),o("Program",e),l="undefined"==typeof module?window.falafel:require("free-falafel"),i=function(n){var t,e,u,r,i;return e=function(n){var t,e,u;null!==n.unifyType&&(t=Array(n.unifyIndent+5).join(" "),"JsUnifyCall"===n.unifyType?n.update(["(function(){","var JSUnify = typeof(module) == 'undefined' || typeof(require) == 'undefined' ? window.JSUnify : require('jsunify');","var $var = JSUnify.variable;",n.isUnifyProg?"return new JSUnify.Program()\n"+n.arguments[0].source():"return "+n.arguments[0].source()+";","})()"].join("\n"+t)):"ProgramRoot"===n.unifyType?n.update(n.body.source()):"OutCall"===n.unifyType?"LogicalExpression"===n.type||"BinaryExpression"===n.type?n.update(""+n.left.source()+", "+n.right.source()):"ExpressionStatement"===n.type?n.update(""+t+".rule("+n.expression.source()+")"):"BlockStatement"===n.type&&n.update(function(){var t,u,r,i;for(r=n.body,i=[],t=0,u=r.length;u>t;t++)e=r[t],i.push(e.source());return i}().join("\n")):("ExprRoot"===n.unifyType||"InCall"===n.unifyType)&&("CallExpression"===n.type?n.update(['["'+n.callee.name+'",',function(){var t,u,r,i;for(r=n.arguments,i=[],t=0,u=r.length;u>t;t++)e=r[t],i.push(e.source());return i}().join(","),"]"].join("")):"Identifier"===n.type?n.update('$var("'+n.name+'")'):("LogicalExpression"===n.type||"BinaryExpression"===n.type)&&(u={"+":"add","-":"sub","*":"mult","/":"div","==":"eq","===":"eq","%":"mod","!=":"neq","!==":"neq",">":"greater","<":"less",">=":"greaterOrEqual","<=":"lessOrEqual","&&":"and","||":"or"},null!=u[n.operator]&&n.update('["'+u[n.operator]+'", '+n.left.source()+", "+n.right.source()+"]"))))},i=function(n){return"CallExpression"===n.type&&"$jsunify"===n.callee.name},r=function(n){return null!=n.parent&&i(n.parent)},u={ProgramRoot:"OutCall",ExprRoot:"InCall",ProgramRoot:"OutCall",InCall:"InCall",OutCall:"OutCall"},t=function(n){var t,e,o;i(n)?(n.unifyType="JsUnifyCall",n.unifyIndent=n.loc.start.column):r(n)?(n.unifyType="FunctionExpression"===n.type?"ProgramRoot":"ExprRoot",n.isUnifyProg="FunctionExpression"===n.type,n.parent.isUnifyProg=n.isUnifyProg):n.unifyType="FunctionExpression"===n.type?null:"CallExpression"===n.type&&null!=(null!=(t=n.parent)?t.unifyType:void 0)?"InCall":null!=n.parent?null===n.parent.unifyType?null:u[n.parent.unifyType]:null,null!==n.unifyType&&null!=(null!=(e=n.parent)?e.isUnifyProg:void 0)&&null==n.isUnifyProg&&(n.isUnifyProg=n.parent.isUnifyProg),null!==n.unifyType&&null==n.unifyIndent&&null!=(null!=(o=n.parent)?o.unifyIndent:void 0)&&(n.unifyIndent=n.parent.unifyIndent)},""+l(n,{loc:!0},e,t)},o("compile",i)}).call(this);