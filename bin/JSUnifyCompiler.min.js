(function(){var n,t,e,o,r,u,l,i,s,f,a,c=[].slice,p={}.hasOwnProperty,g=function(n,t){function e(){this.constructor=n}for(var o in t)p.call(t,o)&&(n[o]=t[o]);return e.prototype=t.prototype,n.prototype=new e,n.__super__=t.prototype,n};a="undefined"==typeof module?window.unify:require("unify"),"undefined"==typeof module&&(window.JSUnify={}),i=function(n,t){return"undefined"==typeof module?window.JSUnify[n]=t:module.exports[n]=t};for(f in a)i(f,a[f]);n=function(){function n(n){this.level=0,this.logger=n}return n.prototype.event=function(n,t){return("fail"===n||"exit"===n)&&this.level--,this.logger.log(""+this.level+" "+n+": "+t),"call"===n?this.level++:void 0},n}(),o=function(){function n(){this.rules=[],this.settings={debug:!1}}return n.prototype.run=function(n){var e;return n=a.box(n),e=function(t,e,o){return"try"===t&&console.log("try: "+a.toJson(e.goal.unbox())),"next"===t&&null!==e.rule?console.log("next: "+a.toJson(e.rule.tin.unbox())):"next"===t&&console.log("next:"),"fail"===t&&console.log("fail "+a.toJson(e.goal.unbox())),"success"===t&&(console.log(""),console.log(n.unbox()),console.log("")),null!==o?o():void 0},u(this.rules,[new t([n])],e)},n.prototype.rule=function(){var n,t;return t=arguments[0],n=arguments.length>=2?c.call(arguments,1):[],this.rules.push(function(n,t,e){e.prototype=n.prototype;var o=new e,r=n.apply(o,t);return Object(r)===r?r:o}(r,[t].concat(c.call(n)),function(){})),this},n.prototype.iff=function(n){var t;if(0===this.rules.length)throw"iff is invalid in this context. A rule must be created first!";return t=this.rules[this.rules.length-1],t.iff(n),this},n.prototype.load=function(n){var t,e,o;for(e=0,o=n.length;o>e;e++)t=n[e],this.rules.push(t);return this},n}(),r=function(){function n(){var n,t,e,o,r;for(e=arguments[0],t=arguments.length>=2?c.call(arguments,1):[],this.fact=e,this.tin=a.box(e),this.conditions=[],o=0,r=t.length;r>o;o++)n=t[o],this.iff(n)}return n.prototype.iff=function(n){var t,o,r,u,l;if(n=a.types.isFunc(n)?new e(n):a.box(n),0===this.conditions.length){t={},u=this.tin.varlist;for(o in u)r=u[o],t[o]=r}else t=this.conditions[0].varlist;l=n.varlist;for(o in l)r=l[o],void 0===t[o]&&(t[o]=r);return n.varlist=t,this.conditions.push(n),this},n}(),e=function(n){function t(n){this.func=n,t.__super__.constructor.call(this,null,null,{})}return g(t,n),t.prototype.toString=function(){return(""+this.func).replace(/(\r\n|\n|\r)/gm,"")},t.prototype.unbox=function(){return""+this},t}(a.TreeTin),t=function(){function n(n){this.subgoals=n,this.goal=this.subgoals.shift(),this.currentRule=0}return n}(),u=function(n,o,r){var l,i,s,f;if(l=o[o.length-1],i=l.goal,f=!1,s=null,0===l.currentRule?r("try",{goal:i},null):(r("retry",{goal:i},null),i.rollback()),i instanceof e)0===l.currentRule&&i.func(i)&&(f=!0,l.currentRule++);else for(;l.currentRule<n.length;){if(i.unify(n[l.currentRule].tin)){f=!0,s=n[l.currentRule],l.currentRule++;break}l.currentRule++}f?null!==s&&0!==s.conditions.length?(o.push(new t(s.conditions.concat(l.subgoals))),r("next",{goal:i,subgoals:l.subgoals,rule:s},function(){return u(n,o,r)})):0===l.subgoals.length?r("success",{goal:i},function(){return u(n,o,r)}):(o.push(new t(l.subgoals)),r("next",{goal:i,subgoals:null,rule:s},function(){return u(n,o,r)})):(o.pop(),0===o.length?(r("fail",{goal:i},null),r("done",{goal:i},null)):r("fail",{goal:i},function(){return u(n,o,r)}))},i("Rule",r),i("Program",o),s="undefined"==typeof module?window.falafel:require("free-falafel"),l=function(n){var t,e,o,r,u;return e=function(n){var t,e,o;null!==n.unifyType&&(t=Array(n.unifyIndent+5).join(" "),"JsUnifyCall"===n.unifyType?n.update(["(function(){","var JSUnify = typeof(module) == 'undefined' || typeof(require) == 'undefined' ? window.JSUnify : require('jsunify');","var $var = JSUnify.variable;",n.isUnifyProg?"return new JSUnify.Program()\n"+n.arguments[0].source():"return "+n.arguments[0].source()+";","})()"].join("\n"+t)):"ProgramRoot"===n.unifyType?n.update(n.body.source()):"OutCall"===n.unifyType?"LogicalExpression"===n.type||"BinaryExpression"===n.type?n.update(""+n.left.source()+", "+n.right.source()):"ExpressionStatement"===n.type?n.update(""+t+".rule("+n.expression.source()+")"):"BlockStatement"===n.type&&n.update(function(){var t,o,r,u;for(r=n.body,u=[],t=0,o=r.length;o>t;t++)e=r[t],u.push(e.source());return u}().join("\n")):("ExprRoot"===n.unifyType||"InCall"===n.unifyType)&&("CallExpression"===n.type?n.update(['["'+n.callee.name+'",',function(){var t,o,r,u;for(r=n.arguments,u=[],t=0,o=r.length;o>t;t++)e=r[t],u.push(e.source());return u}().join(","),"]"].join("")):"Identifier"===n.type?n.update('$var("'+n.name+'")'):("LogicalExpression"===n.type||"BinaryExpression"===n.type)&&(o={"+":"add","-":"sub","*":"mult","/":"div","==":"eq","===":"eq","%":"mod","!=":"neq","!==":"neq",">":"greater","<":"less",">=":"greaterOrEqual","<=":"lessOrEqual","&&":"and","||":"or"},null!=o[n.operator]&&n.update('["'+o[n.operator]+'", '+n.left.source()+", "+n.right.source()+"]"))))},u=function(n){return"CallExpression"===n.type&&"$jsunify"===n.callee.name},r=function(n){return null!=n.parent&&u(n.parent)},o={ProgramRoot:"OutCall",ExprRoot:"InCall",ProgramRoot:"OutCall",InCall:"InCall",OutCall:"OutCall"},t=function(n){var t,e,l;u(n)?(n.unifyType="JsUnifyCall",n.unifyIndent=n.loc.start.column):r(n)?(n.unifyType="FunctionExpression"===n.type?"ProgramRoot":"ExprRoot",n.isUnifyProg="FunctionExpression"===n.type,n.parent.isUnifyProg=n.isUnifyProg):n.unifyType="FunctionExpression"===n.type?null:"CallExpression"===n.type&&null!=(null!=(t=n.parent)?t.unifyType:void 0)?"InCall":null!=n.parent?null===n.parent.unifyType?null:o[n.parent.unifyType]:null,null!==n.unifyType&&null!=(null!=(e=n.parent)?e.isUnifyProg:void 0)&&null==n.isUnifyProg&&(n.isUnifyProg=n.parent.isUnifyProg),null!==n.unifyType&&null==n.unifyIndent&&null!=(null!=(l=n.parent)?l.unifyIndent:void 0)&&(n.unifyIndent=n.parent.unifyIndent)},""+s(n,{loc:!0},e,t)},i("compile",l)}).call(this);