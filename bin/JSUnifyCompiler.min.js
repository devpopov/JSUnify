(function(){var n,e,t,o,i,l,u,r,s,a,f,c=[].slice,p={}.hasOwnProperty,y=function(n,e){function t(){this.constructor=n}for(var o in e)p.call(e,o)&&(n[o]=e[o]);return t.prototype=e.prototype,n.prototype=new t,n.__super__=e.prototype,n};f="undefined"==typeof module?window.unify:require("unify"),"undefined"==typeof module&&(window.JSUnify={}),r=function(n,e){return"undefined"==typeof module?window.JSUnify[n]=e:module.exports[n]=e};for(a in f)r(a,f[a]);n=function(){function n(n){this.level=0,this.logger=n}return n.prototype.event=function(n,e){return("fail"===n||"exit"===n)&&this.level--,this.logger.log(""+this.level+" "+n+": "+e),"call"===n?this.level++:void 0},n}(),o=function(){function n(){this.rules=[],this.settings={debug:!1}}return n.prototype.run=function(n){var t;return n=f.box(n),t=function(e,t){return"try"===e.name&&console.log("try: "+f.toJson(e.goal.unbox())),"next"===e.name&&null!==e.rule?console.log("next: "+f.toJson(e.rule.tin.unbox())):"next"===e.name&&console.log("next:"),"fail"===e.name&&console.log("fail "+f.toJson(e.goal.unbox())),"success"===e.name&&(console.log(""),console.log(f.toJson(n.unbox())),console.log("")),null!==t?t():void 0},l(this.rules,[new e([n])],t)},n.prototype.rule=function(){var n,e;return e=arguments[0],n=arguments.length>=2?c.call(arguments,1):[],this.rules.push(function(n,e,t){t.prototype=n.prototype;var o=new t,i=n.apply(o,e);return Object(i)===i?i:o}(i,[e].concat(c.call(n)),function(){})),this},n.prototype.iff=function(n){var e;if(0===this.rules.length)throw"iff is invalid in this context. A rule must be created first!";return e=this.rules[this.rules.length-1],e.iff(n),this},n.prototype.load=function(n){var e,t,o;for(t=0,o=n.length;o>t;t++)e=n[t],this.rules.push(e);return this},n}(),i=function(){function n(){var e,t,o,i,l;for(o=arguments[0],t=arguments.length>=2?c.call(arguments,1):[],this.clone=function(){return function(n,e,t){t.prototype=n.prototype;var o=new t,i=n.apply(o,e);return Object(i)===i?i:o}(n,[o].concat(c.call(t)),function(){})},this.fact=o,this.tin=f.box(o),this.conditions=[],i=0,l=t.length;l>i;i++)e=t[i],this.iff(e)}return n.prototype.iff=function(n){var e,o,i,l,u;if(n=f.types.isFunc(n)?new t(n):f.box(n),0===this.conditions.length){e={},l=this.tin.varlist;for(o in l)i=l[o],e[o]=i}else e=this.conditions[0].varlist;u=n.varlist;for(o in u)i=u[o],void 0===e[o]&&(e[o]=i);return n.varlist=e,this.conditions.push(n),this},n}(),t=function(n){function e(n){this.func=n,e.__super__.constructor.call(this,null,null,{})}return y(e,n),e.prototype.toString=function(){return(""+this.func).replace(/(\r\n|\n|\r)/gm,"")},e.prototype.unbox=function(){return""+this},e}(f.TreeTin),e=function(){function n(n){this.subgoals=n,this.goal=this.subgoals.shift(),this.ruleIndex=0,this.satisfyingRule=null}return n}(),l=function(n,o,i){var u,r,s;if(u=o[o.length-1],r=u.goal,s=!1,u.satisfyingRule=null,0===u.ruleIndex?i({name:"try",goal:r},null):(i({name:"retry",goal:r},null),r.rollback()),r instanceof t)0===u.ruleIndex&&r.func(r)&&(s=!0,u.ruleIndex++);else for(;u.ruleIndex<n.length;){if(r.unify(n[u.ruleIndex].tin)){s=!0,u.satisfyingRule=n[u.ruleIndex],n[u.ruleIndex]=u.satisfyingRule.clone(),u.ruleIndex++;break}u.ruleIndex++}s?null!==u.satisfyingRule&&0!==u.satisfyingRule.conditions.length?(o.push(new e(u.satisfyingRule.conditions.concat(u.subgoals))),i({name:"next",goal:r,subgoals:u.subgoals,rule:u.satisfyingRule},function(){return l(n,o,i)})):0===u.subgoals.length?i({name:"success",goal:r},function(){return l(n,o,i)}):(o.push(new e(u.subgoals)),i({name:"next",goal:r,subgoals:null,rule:u.satisfyingRule},function(){return l(n,o,i)})):(o.pop(),0===o.length?(i({name:"fail",goal:r},null),i({name:"done",goal:r},null)):i({name:"fail",goal:r},function(){return l(n,o,i)}))},r("Rule",i),r("Program",o),s="undefined"==typeof module?window.falafel:require("free-falafel"),u=function(n){var e,t,o,i,l;return t=function(n){var e,t,o;null!==n.unifyType&&(e=Array(n.unifyIndent+5).join(" "),"JsUnifyCall"===n.unifyType?n.update(["(function(){","var JSUnify = typeof(module) == 'undefined' || typeof(require) == 'undefined' ? window.JSUnify : require('jsunify');","var $var = JSUnify.variable;",n.isUnifyProg?"return new JSUnify.Program()\n"+n.arguments[0].source():"return "+n.arguments[0].source()+";","})()"].join("\n"+e)):"ProgramRoot"===n.unifyType?n.update(n.body.source()):"OutCall"===n.unifyType?"LogicalExpression"===n.type||"BinaryExpression"===n.type?n.update(""+n.left.source()+", "+n.right.source()):"ExpressionStatement"===n.type?n.update(""+e+".rule("+n.expression.source()+")"):"BlockStatement"===n.type&&n.update(function(){var e,o,i,l;for(i=n.body,l=[],e=0,o=i.length;o>e;e++)t=i[e],l.push(t.source());return l}().join("\n")):("ExprRoot"===n.unifyType||"InCall"===n.unifyType)&&("CallExpression"===n.type?n.update(['["'+n.callee.name+'",',function(){var e,o,i,l;for(i=n.arguments,l=[],e=0,o=i.length;o>e;e++)t=i[e],l.push(t.source());return l}().join(","),"]"].join("")):"Identifier"===n.type?n.update('$var("'+n.name+'")'):("LogicalExpression"===n.type||"BinaryExpression"===n.type)&&(o={"+":"add","-":"sub","*":"mult","/":"div","==":"eq","===":"eq","%":"mod","!=":"neq","!==":"neq",">":"greater","<":"less",">=":"greaterOrEqual","<=":"lessOrEqual","&&":"and","||":"or"},null!=o[n.operator]&&n.update('["'+o[n.operator]+'", '+n.left.source()+", "+n.right.source()+"]"))))},l=function(n){return"CallExpression"===n.type&&"$jsunify"===n.callee.name},i=function(n){return null!=n.parent&&l(n.parent)},o={ProgramRoot:"OutCall",ExprRoot:"InCall",ProgramRoot:"OutCall",InCall:"InCall",OutCall:"OutCall"},e=function(n){var e,t,u;l(n)?(n.unifyType="JsUnifyCall",n.unifyIndent=n.loc.start.column):i(n)?(n.unifyType="FunctionExpression"===n.type?"ProgramRoot":"ExprRoot",n.isUnifyProg="FunctionExpression"===n.type,n.parent.isUnifyProg=n.isUnifyProg):n.unifyType="FunctionExpression"===n.type?null:"CallExpression"===n.type&&null!=(null!=(e=n.parent)?e.unifyType:void 0)?"InCall":null!=n.parent?null===n.parent.unifyType?null:o[n.parent.unifyType]:null,null!==n.unifyType&&null!=(null!=(t=n.parent)?t.isUnifyProg:void 0)&&null==n.isUnifyProg&&(n.isUnifyProg=n.parent.isUnifyProg),null!==n.unifyType&&null==n.unifyIndent&&null!=(null!=(u=n.parent)?u.unifyIndent:void 0)&&(n.unifyIndent=n.parent.unifyIndent)},""+s(n,{loc:!0},t,e)},r("compile",u)}).call(this);