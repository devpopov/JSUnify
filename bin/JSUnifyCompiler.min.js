(function(){var n,t,e,i,r,o,u,l,s,f,a,p,c=[].slice,y={}.hasOwnProperty,h=function(n,t){function e(){this.constructor=n}for(var i in t)y.call(t,i)&&(n[i]=t[i]);return e.prototype=t.prototype,n.prototype=new e,n.__super__=t.prototype,n};p="undefined"==typeof module?window.unify:require("unify"),"undefined"==typeof module&&(window.JSUnify={}),u=function(n,t){return"undefined"==typeof module?window.JSUnify[n]=t:module.exports[n]=t};for(s in p)u(s,p[s]);n=function(){function n(n){this.level=0,this.logger=n}return n.prototype.event=function(n,t){return("fail"===n||"exit"===n)&&this.level--,this.logger.log(""+this.level+" "+n+": "+t),"call"===n?this.level++:void 0},n}(),e=function(){function t(){this.rules=[],this.settings={debug:!1}}return t.prototype.run=function(t){return t=new i(t),r(t,this.rules,this.settings.debug?new n(console):{event:function(){}})},t.prototype.rule=function(){var n,t;return t=arguments[0],n=arguments.length>=2?c.call(arguments,1):[],this.rules.push(function(n,t,e){e.prototype=n.prototype;var i=new e,r=n.apply(i,t);return Object(r)===r?r:i}(i,[t].concat(c.call(n)),function(){})),this},t.prototype.iff=function(n){var t;if(0===this.rules.length)throw"iff is invalid in this context. A rule must be created first!";return t=this.rules[this.rules.length-1],t.iff(n),this},t.prototype.load=function(n){var t,e,i;for(e=0,i=n.length;i>e;e++)t=n[e],this.rules.push(t);return this},t}(),i=function(){function n(){var n,t,e,i,r;for(e=arguments[0],t=arguments.length>=2?c.call(arguments,1):[],this.fact=e,this.tin=p.box(e),this.conditions=[],i=0,r=t.length;r>i;i++)n=t[i],this.iff(n)}return n.prototype.iff=function(n){var e,i,r,o,u;if(n=p.types.isFunc(n)?new t(n):p.box(n),0===this.conditions.length){e={},o=this.tin.varlist;for(i in o)r=o[i],e[i]=r}else e=this.conditions[0].varlist;u=n.varlist;for(i in u)r=u[i],void 0===e[i]&&(e[i]=r);return n.varlist=e,this.conditions.push(n),this},n}(),t=function(n){function t(n){this.func=n,t.__super__.constructor.call(this,null,null,{})}return h(t,n),t.prototype.toString=function(){return(""+this.func).replace(/(\r\n|\n|\r)/gm,"")},t}(p.TreeTin),r=function(n,e,r){var o,u,l,s,p;for(n instanceof i&&(n=[n.tin]),o=n.pop(),r.event("call",o),s=0,p=e.length;p>s;s++)if(l=e[s],u=o instanceof t?f(o,l,n,e,r):a(o,l,n,e,r),null!==u)return r.event("exit",o),u;return r.event("fail",o),n.push(o),null},a=function(n,t,e,i,o){var u,l,s,f,a;if(u=[],n.unify(t.tin)){for(o.event("call",t.tin),t.conditions.reverse(),a=t.conditions,s=0,f=a.length;f>s;s++)l=a[s],e.push(l);if(t.conditions.reverse(),0===e.length)return n;if(null!==r(e,i,o))return n}return o.event("fail",t.tin),n.rollback(),null},f=function(n){return n.func(n)?n:null},u("Rule",i),u("Program",e),l="undefined"==typeof module?window.falafel:require("free-falafel"),o=function(n){var t,e,i,r,o;return e=function(n){var t,e,i;null!==n.unifyType&&(t=Array(n.unifyIndent+5).join(" "),"JsUnifyCall"===n.unifyType?n.update(["(function(){","var JSUnify = typeof(module) == 'undefined' || typeof(require) == 'undefined' ? window.JSUnify : require('jsunify');","var $var = JSUnify.variable;",n.isUnifyProg?"return new JSUnify.Program()\n"+n.arguments[0].source():"return "+n.arguments[0].source()+";","})()"].join("\n"+t)):"ProgramRoot"===n.unifyType?n.update(n.body.source()):"OutCall"===n.unifyType?"LogicalExpression"===n.type||"BinaryExpression"===n.type?n.update(""+n.left.source()+", "+n.right.source()):"ExpressionStatement"===n.type?n.update(""+t+".rule("+n.expression.source()+")"):"BlockStatement"===n.type&&n.update(function(){var t,i,r,o;for(r=n.body,o=[],t=0,i=r.length;i>t;t++)e=r[t],o.push(e.source());return o}().join("\n")):("ExprRoot"===n.unifyType||"InCall"===n.unifyType)&&("CallExpression"===n.type?n.update(['["'+n.callee.name+'",',function(){var t,i,r,o;for(r=n.arguments,o=[],t=0,i=r.length;i>t;t++)e=r[t],o.push(e.source());return o}().join(","),"]"].join("")):"Identifier"===n.type?n.update('$var("'+n.name+'")'):("LogicalExpression"===n.type||"BinaryExpression"===n.type)&&(i={"+":"add","-":"sub","*":"mult","/":"div","==":"eq","===":"eq","%":"mod","!=":"neq","!==":"neq",">":"greater","<":"less",">=":"greaterOrEqual","<=":"lessOrEqual","&&":"and","||":"or"},null!=i[n.operator]&&n.update('["'+i[n.operator]+'", '+n.left.source()+", "+n.right.source()+"]"))))},o=function(n){return"CallExpression"===n.type&&"$jsunify"===n.callee.name},r=function(n){return null!=n.parent&&o(n.parent)},i={ProgramRoot:"OutCall",ExprRoot:"InCall",ProgramRoot:"OutCall",InCall:"InCall",OutCall:"OutCall"},t=function(n){var t,e,u;o(n)?(n.unifyType="JsUnifyCall",n.unifyIndent=n.loc.start.column):r(n)?(n.unifyType="FunctionExpression"===n.type?"ProgramRoot":"ExprRoot",n.isUnifyProg="FunctionExpression"===n.type,n.parent.isUnifyProg=n.isUnifyProg):n.unifyType="FunctionExpression"===n.type?null:"CallExpression"===n.type&&null!=(null!=(t=n.parent)?t.unifyType:void 0)?"InCall":null!=n.parent?null===n.parent.unifyType?null:i[n.parent.unifyType]:null,null!==n.unifyType&&null!=(null!=(e=n.parent)?e.isUnifyProg:void 0)&&null==n.isUnifyProg&&(n.isUnifyProg=n.parent.isUnifyProg),null!==n.unifyType&&null==n.unifyIndent&&null!=(null!=(u=n.parent)?u.unifyIndent:void 0)&&(n.unifyIndent=n.parent.unifyIndent)},""+l(n,{loc:!0},e,t)},u("compile",o)}).call(this);