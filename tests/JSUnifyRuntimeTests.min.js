(function(){var Box,DICT_FLAG,DictFlag,FunctionCondition,HIDDEN_VAR_PREFIX,Program,Rule,Tin,Var,Variable,backtrack,bind,bind_tins,boxit,dir,extern,fulltest,g_hidden_var_counter,get_tin,gettest,internal,isHiddenVar,isarray,isbool,isfunc,isnum,isobj,isstr,isundef,isvaluetype,len,log,parse,parsetest,rollback,runtests,str,toJson,tryFunctionCondition,tryUnifyCondition,unboxit,unify,unifyfailtest,unifytest,_unify,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};log=function(e){return console.log(e)},dir=function(e){return console.dir(e)},len=function(e){return e.length},typeof exports=="undefined"&&(window.JSUnify={}),extern=function(e,t){return typeof exports=="undefined"?window.JSUnify[e]=t:exports[e]=t},typeof exports=="undefined"?window.JSUnify.internal={}:exports.internal={},internal=function(e,t){return typeof exports=="undefined"?window.JSUnify.internal[e]=t:exports.internal[e]=t},str=function(e){return typeof e=="undefined"?"undefined":e===null?"null":e.toString()},isundef=function(e){return typeof e=="undefined"},isbool=function(e){return typeof e=="boolean"},isarray=function(e){return e!=null&&Array.isArray(e)},isstr=function(e){return typeof e=="string"},isnum=function(e){return typeof e=="number"},isobj=function(e){return e!==null&&!isarray(e)&&typeof e=="object"},isvaluetype=function(e){return isbool(e)||isstr(e)||isnum(e)},isfunc=function(e){return!!(e&&e.constructor&&e.call&&e.apply)},toJson=function(e){var t;return isarray(e)?"["+function(){var n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(toJson(t));return i}().join(",")+"]":e instanceof Box||e instanceof Tin||e instanceof Variable||e instanceof DictFlag?str(e):isobj(e)?"{"+function(){var n;n=[];for(t in e)n.push(t+":"+toJson(e[t]));return n}().join(",")+"}":isstr(e)?'"'+e+'"':str(e)},DictFlag=function(){function e(){}return e.prototype.toString=function(){return"new DictFlag()"},e}(),DICT_FLAG=new DictFlag,Box=function(){function e(e){if(!isvaluetype(e)&&e!==null)throw"Can only box value types, not "+toJson(e);this.value=e}return e.prototype.toString=function(){return"new Box("+toJson(this.value)+")"},e}(),g_hidden_var_counter=1,HIDDEN_VAR_PREFIX="__B3qgfO__",isHiddenVar=function(e){return e.slice(0,HIDDEN_VAR_PREFIX.length)===HIDDEN_VAR_PREFIX},Variable=function(){function e(e){e==="_"?(this.name=HIDDEN_VAR_PREFIX+g_hidden_var_counter,g_hidden_var_counter+=1):this.name=e}return e.prototype.isHiddenVar=function(){return isHiddenVar(this.name)},e.prototype.toString=function(){return"Var("+toJson(this.name)+")"},e}(),Var=function(e){return new Variable(e)},Tin=function(){function e(e,t,n){this.node=t!=null?t:null,this.varlist=isobj(n)?n:null,this.chainlength=1,this.name=e}return e.prototype.end_of_chain=function(){var t;t=this;while(t.varlist instanceof e)t=t.varlist;return t},e.prototype.isfree=function(){var e;return e=this.end_of_chain(),e.node===null&&e.varlist===null},e.prototype.isHiddenVar=function(){return isHiddenVar(this.name)},e.prototype.toString=function(){return"new Tin("+toJson(this.name)+", "+toJson(this.node)+", "+toJson(this.varlist)+")"},e.prototype.get=function(e){var t,n;n=this.varlist[e],n!==null&&n!==void 0&&(n=n.end_of_chain());if(n==null)throw"Variable "+e+" not in this tin";if(n.node==null||n.node===null)return new Var(n.name);if(n.node instanceof Box)return unboxit(n.node,n.varlist);if(n.node instanceof Var)return unboxit(n.node,n.varlist);if(isarray(n.node))return function(){var e,r,i,s;i=n.node,s=[];for(e=0,r=i.length;e<r;e++)t=i[e],s.push(unboxit(t,n.varlist));return s}();throw"Unknown type in get"},e.prototype.get_all=function(){var e,t;e={};for(t in this.varlist)isHiddenVar(t)||(e[t]=this.get(t));return e},e.prototype.unparse=function(){return unboxit(this.node)},e}(),boxit=function(e,t){var n,r,i;if(e instanceof Variable)return t!=null&&(t[e.name]=new Tin(e.name,null,null)),e;if(e instanceof Box)return e;if(isarray(e))return function(){var n,i,s;s=[];for(n=0,i=e.length;n<i;n++)r=e[n],s.push(boxit(r,t));return s}();if(isobj(e)){n=[];for(i in e)n.push([boxit(i,t),boxit(e[i],t)]);return n.push(DICT_FLAG),n.sort()}if(isvaluetype(e||e===null))return new Box(e);throw"Don't understand the type of elem"},unboxit=function(e,t){var n,r,i,s,o,u,a;if(isarray(e)){if(e[e.length-1]===DICT_FLAG){r=new Object,a=e.slice(0,e.length-1);for(o=0,u=a.length;o<u;o++)n=a[o],r[unboxit(n[0])]=unboxit(n[1]);return r}return function(){var t,n,r;r=[];for(t=0,n=e.length;t<n;t++)i=e[t],r.push(unboxit(i));return r}()}if(e instanceof Box)return e.value;if(e instanceof Variable){if(t!==void 0){try{s=get_tin(t,e)}catch(f){return e}return unboxit(s.node,s.varlist)}return e}throw"Unrecognized type '"+typeof e+"' in unboxit"},parse=function(e){var t,n;return t={},n=boxit(e,t),new Tin(null,n,t)},get_tin=function(e,t){if(!t instanceof Variable)throw"Node must be a Var to get_tin";if((e!=null?e[t.name]:void 0)!=null)return e[t.name];throw"Couldn't find node "+t.name+" in varlist "+e},bind=function(e,t,n,r){return e=e.end_of_chain(),e.isfree()?(e.node=t,e.varlist=n,r.push(function(){return e.node=null,e.varlist=null,e.chainlength=1})):!1},bind_tins=function(e,t,n){return!e.isfree()&&!t.isfree()?!1:e.isfree()&&!t.isfree()?bind(e,t.node,t.varlist,n):!e.isfree()&&t.isfree()?bind(t,e.node,e.varlist,n):t.chainlength<e.chainlength?(t.chainlength+=1,bind(t,null,e,n)):(e.chainlength+=1,bind(e,null,t,n))},_unify=function(e,t,n,r,i){var s,o,u,a,f,l,c;i==null&&(i=[]);if(e===void 0&&n===void 0)return!0;if(e===null&&n===null)return!0;if(e===null||n===null)return!1;if(e instanceof Variable&&n instanceof Variable){u=get_tin(t,e),a=get_tin(r,n);if(!bind_tins(u,a,i)&&!_unify(u.node,u.varlist,a.node,a.varlist,i))return!1}else if(e instanceof Variable){u=get_tin(t,e);if(!bind(u,n,r,i)&&!_unify(u.node,u.varlist,n,r,i))return!1}else if(n instanceof Variable){a=get_tin(r,n);if(!bind(a,e,t,i)&&!_unify(a.node,a.varlist,e,t,i))return!1}else{if(e instanceof Box&&n instanceof Box&&isvaluetype(e.value)&&isvaluetype(n.value))return e.value===n.value;if(isarray(e)&&isarray(n)){if(e.length!==n.length)return!1;c=function(){var t,n,r;r=[];for(o=t=0,n=e.length;0<=n?t<=n:t>=n;o=0<=n?++t:--t)r.push(o);return r}();for(f=0,l=c.length;f<l;f++){s=c[f];if(!_unify(e[s],t,n[s],r,i))return!1}}}return!0},unify=function(e,t,n){var r;return n==null&&(n=[]),r=!0,e=e instanceof Tin?e:parse(e),t=t instanceof Tin?t:parse(t),r=_unify(e.node,e.varlist,t.node,t.varlist,n),r===!1?null:[e,t]},rollback=function(e){var t,n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(t());return i},extern("parse",parse),extern("unify",unify),extern("Var",Var),internal("Tin",Tin),internal("Box",Box),internal("DictFlag",DictFlag),internal("toJson",toJson),internal("Variable",Variable),extern("rollback",rollback),Program=function(){function e(){this.rules=[]}return e.prototype.run=function(e){return e=new Rule(e),backtrack(e,this.rules)},e.prototype.rule=function(){var e,t;return t=arguments[0],e=2<=arguments.length?__slice.call(arguments,1):[],this.rules.push(function(e,t,n){n.prototype=e.prototype;var r=new n,i=e.apply(r,t),s=typeof i;return s=="object"||s=="function"?i||r:r}(Rule,[t].concat(__slice.call(e)),function(){})),this},e.prototype.iff=function(e){var t;if(this.rules.length===0)throw"iff is invalid in this context. A rule must be created first!";return t=this.rules[this.rules.length-1],t.iff(e),this},e.prototype.load=function(e){var t,n,r;for(n=0,r=e.length;n<r;n++)t=e[n],this.rules.push(t);return this},e}(),Rule=function(){function e(){var e,t,n,r,i;n=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],this.fact=n,this.tin=parse(n),this.conditions=[];for(r=0,i=t.length;r<i;r++)e=t[r],this.iff(e)}return e.prototype.iff=function(e){var t,n,r,i,s;isfunc(e)?e=new FunctionCondition(e):e=parse(e);if(this.conditions.length===0){t={},i=this.tin.varlist;for(n in i)r=i[n],t[n]=r}else t=this.conditions[0].varlist;s=e.varlist;for(n in s)r=s[n],t[n]===void 0&&(t[n]=r);return e.varlist=t,this.conditions.push(e),this},e}(),FunctionCondition=function(e){function t(e){this.func=e,t.__super__.constructor.call(this,null,null,{})}return __extends(t,e),t.prototype.bind=function(e,t){var n;return n=this.varlist[e].end_of_chain(),n.isfree()?(n.node=boxit(t,{}),!0):unboxit(n.node)===t?!0:!1},t}(Tin),backtrack=function(e,t){var n,r,i,s,o;e instanceof Rule&&(e=[e.tin]),n=e.pop();for(s=0,o=t.length;s<o;s++){i=t[s],n instanceof FunctionCondition?r=tryFunctionCondition(n,i,e,t):r=tryUnifyCondition(n,i,e,t);if(r!==null)return r}return e.push(n),null},tryUnifyCondition=function(e,t,n,r){var i,s,o,u,a;i=[];if(unify(e,t.tin,i)){t.conditions.reverse(),a=t.conditions;for(o=0,u=a.length;o<u;o++)s=a[o],n.push(s);t.conditions.reverse();if(n.length===0)return e;if(backtrack(n,r)!==null)return e}return rollback(i),null},tryFunctionCondition=function(e,t,n,r){return e.func(e)?e:null},extern("Rule",Rule),extern("Program",Program),parsetest=function(e){return deepEqual(parse(e).unparse(),e,"parse")},unifytest=function(e,t){return ok(unify(e,t),"unify")},unifyfailtest=function(e,t){return ok(!unify(e,t),"unify fail")},gettest=function(e,t){var n,r;r=[];for(n in t)t[n]instanceof Var?r.push(ok(e.get(n)instanceof Var,"get("+n+") = Var()")):r.push(deepEqual(e.get(n),t[n],"get("+n+") == "+toJson(t[n])));return r},fulltest=function(e,t,n,r){return parsetest(e),parsetest(t),e=parse(e),t=parse(t),unifytest(e,t),gettest(e,n),gettest(t,r)},runtests=function(){var prop;for(prop in JSUnify)window[prop]=JSUnify[prop];for(prop in JSUnify.internal)window[prop]=JSUnify.internal[prop];return module("full tests"),test("empty obj {} -> {}",function(){return fulltest({},{},{},{})}),test("null test [null] -> [null]",function(){return fulltest([null],[null],{},{})}),test("variable equal [X] -> [1]",function(){return fulltest([Var("a")],[1],{a:1},{})}),test("variable equal [X,X] -> [1,1]",function(){return fulltest([Var("a"),Var("a")],[1,1],{a:1},{})}),test("variable equal [[1,2,3]] -> [y]",function(){return fulltest([[1,2,3]],[Var("y")],{},{y:[1,2,3]})}),test("variable equal [[1,2,x],x] -> [y,3]",function(){return fulltest([[1,2,Var("x")],Var("x")],[Var("y"),3],{x:3},{y:[1,2,3]})}),test("unbound variable [y]->[x]",function(){return fulltest([Var("y")],[Var("x")],{y:Var("x")},{x:Var("x")})}),test("variable equal [1,X,X] -> [Z,Z,1]",function(){return fulltest([1,Var("X"),Var("X")],[Var("Z"),Var("Z"),1],{X:1},{Z:1})}),module("unify fail tests"),test("variable equal [X,X] -> [1,2]",function(){return unifyfailtest([Var("a"),Var("a")],[1,2])}),test("variable unequal [1,3,2] -> [Y,Y,2]",function(){return unifyfailtest([1,3,2],[Var("y"),Var("y"),2])}),test("variable unequal [1,X,X] -> [Z,Z,3]",function(){return unifyfailtest([1,Var("X"),Var("X")],[Var("Z"),Var("Z"),3])}),module("misc"),test("simple black box unify test",function(){return ok(unify({a:[1,2,3]},{a:[1,Var("b"),3]}))}),module("unify"),test("variable equal [X,2,X] -> [1,2,1]",function(){var e;return e=unify([Var("x"),2,Var("x")],[1,2,1]),ok(e),deepEqual(e[0].get_all(),{x:1})}),module("extract"),test("simple variable extraction test",function(){var e;return e=unify({a:[1,2,3]},{a:[1,Var("b"),3]}),ok(e[1].get("b")===2)}),test("extract all variables test",function(){var e;return e=unify({a:[1,2,3]},{a:[1,Var("b"),3]}),deepEqual(e[1].get_all(),{b:2})}),module("hidden variables"),test("create hidden variable",function(){return ok(Var("_").isHiddenVar())}),test("simple hidden variable [_,X] -> [1,2]",function(){return fulltest([Var("_"),Var("x")],[1,2],{x:2},{})}),test("multiple hidden variables [_,_,X] -> [1,2,3]",function(){return fulltest([Var("_"),Var("_"),Var("x")],[1,2,3],{x:3},{})}),test("[[1,_,3],[1,2,3]] -> [X,X]",function(){return fulltest([[1,Var("_"),3],[1,2,3]],[Var("x"),Var("x")],{},{x:[1,2,3]})}),module("rollback"),test("rollback successful unification",function(){var changes,cobj1,cobj2,obj1,obj2;return obj1=[1,2,3],obj2=[Var("A"),Var("B"),3],parsetest(obj1),parsetest(obj2),obj1=parse(obj1),obj2=parse(obj2),cobj1=eval(obj1.toString()),cobj2=eval(obj2.toString()),changes=[],ok(unify(obj1,obj2,changes),"unify"),rollback(changes),ok(obj1.toString()===cobj1.toString()),ok(obj2.toString()===cobj2.toString())})},extern("RunJSUnifyUnitTests",runtests),runtests=function(){return test("placeholder",function(){return ok(!0)}),module("Backtrack"),test("Snowy Chicago",function(){return ok((new Program).rule({snowy:Var("X")},{cold:[Var("X"),Var("Y")]},{rainy:[Var("X"),Var("Y")]}).rule({rainy:["cinci",1]}).rule({rainy:["chicago",1]}).rule({cold:["chicago",1]}).run({snowy:Var("P")}).get("P")==="chicago")}),test("Is Int",function(){var e;return e=(new Program).rule({number:4.4}).rule({number:9}).rule({"int":Var("X")},{number:Var("X")},function(e){var t;return t=e.get("X"),parseInt(t)===t}),ok(e.run({"int":Var("Y")}).get("Y")===9)}),test("N1 Is N-1",function(){var e;return e=(new Program).rule({number:12}).rule({minus:Var("N1")},{number:Var("N")},function(e){var t;return t=e.get("N"),e.bind("N1",t-1)}),ok(e.run({minus:Var("Q")}).get("Q")===11)}),test("Illegal rebind",function(){var e;return e=(new Program).rule({number:12}).rule({minus:Var("N1")},{number:Var("N")},function(e){var t;return t=e.get("N"),e.bind("N",t+1)}),ok(e.run({minus:Var("Q")})===null)}),test("Legal rebind - values equal",function(){var e;return e=(new Program).rule({number:12}).rule({minus:Var("N")},{number:Var("N")},function(e){var t;return t=e.get("N"),e.bind("N",t)}),ok(e.run({minus:Var("Q")}).get("Q")===12)}),test("Deriv 4 * x + 7 * x",function(){var e,t,n,r,i,s,o,u,a;return e=Var("C"),u=Var("X"),s=Var("U"),t=Var("DU"),o=Var("V"),n=Var("DV"),r=Var("N"),i=Var("N1"),a=(new Program).rule({deriv:[e,u,0]},function(e){return isnum(e.get("C"))}).rule({deriv:[u,u,1]}).rule({deriv:[{mult:[e,s]},u,{mult:[e,t]}]},function(e){return isnum(e.get("C"))},{deriv:[s,u,t]}).rule({deriv:[{mult:[s,o]},u,{add:[{mult:[s,n]},{mult:[o,t]}]}]},{deriv:[s,u,t]},{deriv:[o,u,n]}).rule({deriv:[{add:[s,o]},u,{add:[t,n]}]},{deriv:[s,u,t]},{deriv:[o,u,n]}).rule({deriv:[{sub:[s,o]},u,{sub:[t,n]}]},{deriv:[s,u,t]},{deriv:[o,u,n]}),console.log(a.run({deriv:[{add:[{mult:[7,"x"]},{mult:[4,"x"]}]},"x",Var("DR")]})),ok(!0)}),test("Family Tree",function(){var e,t,n;return n=[],n.push(new Rule({male:["james1"]})),n.push(new Rule({male:["charles2"]})),n.push(new Rule({male:["charles1"]})),n.push(new Rule({male:["james2"]})),n.push(new Rule({male:["george1"]})),n.push(new Rule({female:["catherine"]})),n.push(new Rule({female:["elizabeth"]})),n.push(new Rule({female:["sophia"]})),n.push(new Rule({parent:["charles1","james1"]})),n.push(new Rule({parent:["elizabeth","james1"]})),n.push(new Rule({parent:["charles2","charles1"]})),n.push(new Rule({parent:["catherine","charles1"]})),n.push(new Rule({parent:["james2","charles1"]})),n.push(new Rule({parent:["sophia","elizabeth"]})),n.push(new Rule({parent:["george1","sophia"]})),n.push(new Rule({parent:["george1","james1"]})),n.push(new Rule({father:[Var("Kid"),Var("Dad")]},{male:[Var("Dad")]},{parent:[Var("Kid"),Var("Dad")]})),n.push(new Rule({mother:[Var("Kid"),Var("Mom")]},{female:[Var("Mom")]},{parent:[Var("Kid"),Var("Mom")]})),e=(new Program).load(n),t=e.run({parent:["charles1","george1"]}),ok(t===null),t=e.run({parent:["elizabeth",Var("X")]}),ok(t!==null),ok(t.get("X")==="james1"),t=e.run({mother:["george1",Var("Mom")]}),ok(t!==null),ok(t.get("Mom")==="sophia"),t=e.run({father:["george1",Var("Dad")]}),ok(t!==null),ok(t.get("Dad")==="james1")})},extern("RunJSUnifyLangUnitTests",runtests)}).call(this)